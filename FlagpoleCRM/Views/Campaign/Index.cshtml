@{
    Layout = "/Views/Shared/_Layout.cshtml";
    var accountId = TempData["id"];
    var campaignId = 0;
}
@using Common.Enums;

<style>
    .add-sender-img {
        max-height: 300px;
        margin-bottom: 20px;
    }

    .add-sender-wrapper {
        overflow-y: scroll;
        padding-left: 20px;
        max-height: 600px;
    }
</style>

<main class="page-content">
    <div class="breadcrumb-title pe-3" style="display:flex; justify-content:space-between; align-items:center">
        Campaigns Management
        <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-campaign-modal">
            <i class="bi bi-plus-lg" style="margin: 0"></i> Add campaign
        </a>
    </div>
    <hr>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-2 row-cols-xxl-4">
        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="">
                            <p class="mb-1">Total Campaigns Created</p>
                            <h4 class="mb-0 text-tiffany">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="">
                            <p class="mb-1">Total Campaigns Sent</p>
                            <h4 class="mb-0 text-success">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="">
                            <p class="mb-1">Total Emails Sent</p>
                            <h4 class="mb-0 text-orange">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="">
                            <p class="mb-1">Total Email Addresses</p>
                            <h4 class="mb-0 text-pink">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <a class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#manage-senders-modal">
        <i class="bi bi-envelope-fill" style="margin-left: 0; margin-right: 5px"></i>Manage senders
    </a>
    <div class="table-responsive" style="margin-top:20px">
        <table id="campaign-list" class="table table-striped table-bordered custom-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Channel</th>
                    <th>Status</th>
                    <th>Success</th>
                    <th>Failure</th>
                    <th>Send Date</th>
                    <th>Created Date</th>
                    <th>Task</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="manage-senders"></div>

    <div id="modify-campaign"></div>
</main>

@section Script {
    <script>
        var campaigns;

        $(document).ready(function() {
            loadCampaigns();
            loadManageEmailSenders();
            loadModifyCampaignView();
        });

        function loadCampaigns() {
            $('.loading').css('display', 'block');
            $.ajax({
                url: `@Url.Action("GetListCampaign", "Campaign")?accountId=@accountId&websiteId=${localStorage.getItem('@Common.Constant.CookiesName.CURRENT_WEBSITE')}`,
                type: 'get'
            }).done(function (res) {
                $('.loading').css('display', 'none');
                campaigns = $('#campaign-list').DataTable({
                    destroy: true,
                    searching: true,
                    className: 'dt-body-right',
                    data: res,
                    columns: campaignCols(),
                    order: [[8, 'desc']]
                });

                campaigns.on('order.dt search.dt', function () {
                    campaigns.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1;
                    });
                }).draw();
            });
        }

        function campaignCols() {
            let arr = [
                {
                    data: "name",
                    class: 'text-nowrap',
                    orderable: false
                },
                {
                    data: "name",
                    class: 'text-nowrap',
                    orderable: false
                },
                {
                    data: "description",
                    class: 'text-nowrap',
                    orderable: false
                },
                {
                    data: "channel",
                    class: 'text-nowrap',
                    orderable: false
                },
                {
                    data: "sendStatus",
                    class: 'text-nowrap',
                    orderable: false
                },
                {
                    data: "success",
                    class: 'text-nowrap',
                    orderable: false,
                    render: function(data) {
                        return data ?? '-';
                    }
                },
                {
                    data: "failure",
                    class: 'text-nowrap',
                    orderable: false,
                    render: function (data) {
                        return data ?? '-';
                    }
                },
                {
                    data: "sendDate",
                    class: 'text-nowrap',
                    orderable: false,
                    render: function(data) {
                        return convertDateTime(data);
                    }
                },
                {
                    data: "createdDate",
                    class: 'text-nowrap',
                    orderable: true,
                    render: function(data) {
                        return convertDate(data);
                    }
                },
                {
                    orderable: false,
                    render: function (data, type, row) {
                        if(row.sendStatus == @((int)ESendStatus.Waiting)) {
                            return `<div style="display:flex">
                                        <a class="btn btn-warning" onclick="editCampaign(${row.id})" style="margin-right: 10px">
                                            <i class="bi bi-pencil-square" style="margin: 0"></i></a>
                                        <a class="btn btn-danger" onclick="removeCampaign(${row.id})" data-bs-toggle="modal" data-bs-target="#remove-campaign-modal">
                                            <i class="bi bi-trash" style="margin: 0"></i></a>
                                    </div>`
                        }
                        else {
                            return `<div style="display:flex">
                                        <a class="btn btn-primary" onclick="editCampaign(${row.id})" style="margin-right: 10px">
                                            <i class="bi bi-eye-fill" style="margin: 0"></i></a>
                                    </div>`
                        }
                    }
                }
            ]
            return arr;
        }

        function loadManageEmailSenders() { 
            $.ajax({
                url: `@Url.Action("LoadManageEmailSenders", "Campaign")?accountId=@accountId&websiteId=${localStorage.getItem('@Common.Constant.CookiesName.CURRENT_WEBSITE')}`,
                type: 'get',
                success: (data) => {
                    $('#manage-senders').html(data);
                }
            });
        }

        function loadModifyCampaignView() {
            var websiteGuid = localStorage.getItem('@Common.Constant.CookiesName.CURRENT_WEBSITE');
            var accountEmail = '@TempData["email"]';
            var accountId = '@TempData["id"]';
            var id = @campaignId;
            $.ajax({
                url: `@Url.Action("LoadModifyCampaignView", "Campaign")`,
                type: 'post',
                data: { id, websiteGuid, accountEmail, accountId },
                success: (data) => {
                    $('#modify-campaign').html(data);
                }
            });
        }

        function getCampaignById(id) {
            $.ajax({
                url: `@Url.Action("LoadModifyCampaignView", "Campaign")`,
                type: 'post',
                data: { id, websiteGuid, accountEmail, accountId },
                success: (data) => {
                    $('#modify-campaign').html(data);
                }
            });
        }

        function editCampaign(id) {

        }

        $('#choose-websites').change(function () {
            loadCampaigns();
            loadManageEmailSenders();
        });
    </script>
}
